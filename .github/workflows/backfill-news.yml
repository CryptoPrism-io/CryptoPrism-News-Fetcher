name: Backfill Crypto News

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: "Start date (YYYY-MM-DD)"
        required: true
        default: "2026-02-04"
      end_date:
        description: "End date (YYYY-MM-DD, inclusive)"
        required: true
        default: "2026-02-25"
      window_hours:
        description: "Hours per fetch window (smaller = more API calls but safer)"
        required: false
        default: "24"

jobs:
  backfill:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Create .env file
        run: |
          cat > .env << EOF
          CRYPTOCOMPARE_API_KEY=${{ secrets.CRYPTOCOMPARE_API_KEY }}
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_NAME=${{ secrets.DB_NAME }}
          EOF

      - name: Test DB connection
        run: python -c "from src.news_fetcher.db_cc_news import test_connection; ok = test_connection(); exit(0 if ok else 1)"

      - name: Run backfill
        run: |
          python -m src.news_fetcher.backfill \
            --start "${{ github.event.inputs.start_date }}" \
            --end "${{ github.event.inputs.end_date }}" \
            --window-hours "${{ github.event.inputs.window_hours }}"
